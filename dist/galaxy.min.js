function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.Galaxy={})})(this,function(a){"use strict";function b(a,b){return b={exports:{}},a(b,b.exports),b.exports}function c(a){return null!==a&&"object"==typeof a}function d(a){return a.nodeType===Node.TEXT_NODE}function e(a){return a.nodeType===Node.ELEMENT_NODE}function f(a){return"function"==typeof a}function g(a){return null!=a}function h(a){return a.startsWith("$")||a.startsWith("_")}function i(a){return a instanceof HTMLTemplateElement}function j(a){return!!a.$galaxy}function k(a,b,c=0){const{length:d}=a;let e,f="expr",g=!1;for(const h={start:c,cursor:c,get previous(){return a.charCodeAt(this.cursor-1)},get current(){return a.charCodeAt(this.cursor)},next(){this.cursor++},stop(){g=!0},to(a){this.cursor=a},is(a){return this.current===a}};h.cursor<d&&((h.is(39)||h.is(34))&&("expr"===f?(f="str",e=h.current):h.is(e)&&92!==h.previous&&(f="expr",e=null,h.next())),!("expr"===f&&(b(h),g)));)h.next()}function l({message:a,stack:b}){const c=new V(a);return c.stack=b,c}function m(a){const b=[];let c=0;k(a,d=>{d.is(62)&&124===d.previous&&b.push(a.slice(c,(c=d.cursor+1)-2))});const d=a.slice(c);if(!d.trim().length)throw new V(`Unexpected end of expression filter: ${a}`);return b.length?`_$f(${b[0]}, [${n(b.slice(1).concat(d)).join()}])`:a}function n(a){return a.map(a=>{a=a.trim();const b=W.exec(a);if(!b)throw new V(`Wrong syntax for filter: |> ${a}`);const{groups:c}=b;return`{      name: '${c.name}',      args: ${c.args?`[${c.args}]`:"null"}    }`})}function o(a){let b;const c=[];for(;b=X.exec(a);){const d=a.slice(0,b.index);let e=b.groups.expression.trim();d&&c.push(`\`${d}\``),e&&c.push(`_$n(${m(e)})`),a=a.slice(b.index+b[0].length)}return a&&c.push(`\`${a}\``),c.join(" + ")}function p(a){let b,c="",d=!1,e=0,f=0;return k(a,g=>{switch(g.current){case 35:d=!0,e=g.cursor,b="";break;case 40:{if(!d)return;if(!b.length)throw new V("Unexpected args... Expecting stateful method name");let h,i=1;g.next(),k(a,d=>{d.is(40)?i++:d.is(41)&&! --i&&(h=a.slice(d.start,d.cursor),c+=a.slice(f,e)+`$commit('${b}'${h?`, ${p(h)}`:""})`,f=d.cursor+1,d.stop())},g.cursor),d=!1,g.to(f)}break;default:if(d){const a=String.fromCharCode(g.current);if(b+=a,1===b.length&&/[0-9]/.test(b)||!Y.test(a))throw new V(`Unexpected char in stateful method name: #${b}<-`)}}}),c+a.slice(f)}function q(a){return t(o(a))}function r(a){return t(m(a))}function s(a){return v(p(a))}function t(a){return v(`return ${a}`)}function u(a){return v(`(${a} = __args__[0])`)}function v(a){let b=Z.get(a);return b||(b=new Function("__global__","__locals__","...__args__",`with (__global__) {        with (this) {          with (state) {            with (__locals__) {              ${a}            }          }        }      }`),Z.set(a,b)),(a,c,...d)=>b.call(a,U,c,...d)}function w(a){a=ba(a);const b=a.replace(ga,x("[:\\w-]+"));return new RegExp(`^${b===a?x(a):b}(?:.(?<args>.+))?$`)}function x(a){return`(?${"<name>"}${a})`}function y(a){return a.replace(ea,(a,b)=>b.toUpperCase())}function z(a){return a.replace(fa,(a,b)=>`-${b.toLowerCase()}`).toLowerCase()}function A(a,b,c=da){const d=c(a.getAttribute(b));return Q.debug||a.removeAttribute(b),d}function B(a){return Q.debug?new Comment(` ${a} `):new Text}function C(...a){return Object.assign(Object.create(null),...a)}function D(a,b){return a.nodeValue!==b}function E(a){const b=[];return a.childrenRenderer.renderers.forEach(a=>{b.push(...(a.isFlattenable?E(a):[a]))}),b}function F(a,b,c){a.$emit(`$${b}`,c),b=a[`on${b.charAt(0).toUpperCase()+b.slice(1)}`],f(b)&&S.afterFlush(()=>{b.call(a,c)})}function G(a,b){return a[b]||[]}function H(a,b,c){const d=G(a,b).filter(a=>a!==c);d.length?a[b]=d:delete a[b]}function I(a,b){return Object.assign(a.prototype,...b)}function J(a){return(...b)=>{let c=0;const d=(...b)=>{const e=a[c++];e&&e(d,...b)};d(...b)}}function K(a,b,c,d){const e=new ca(b,{target:c,transitionCb:d});a.dispatchEvent(e),e.perform()}function L(a){const b=r(a.getAttribute("by"));return function(a){return b(this.scope,C(this.isolated,a))}}function M(a){class b extends a{static get is(){return z(this.name)}get $name(){return this.constructor.is}static get children(){return[]}constructor(){super(),_defineProperty(this,"$refs",Object.create(null)),_defineProperty(this,"$events",Object.create(null)),_defineProperty(this,"$parent",null),_defineProperty(this,"$rendering",!1);let a;const{style:b,template:c}=this.constructor;try{a=this.attachShadow({mode:"open"})}catch(a){}if(b instanceof HTMLStyleElement){if(!a)throw new V("style cannot be attached");a.appendChild(b.cloneNode(!0))}if(c instanceof HTMLTemplateElement){if(!a)throw new V("template cannot be attached");a.appendChild(c.content.cloneNode(!0))}this.state={},this.$renderer=new ma(a?a.childNodes:[],this,{}),F(this,"created")}get state(){return oa.get(this)}set state(a){const b=()=>{this.$render()};oa.set(this,T.observe(a,null,b)),b()}connectedCallback(){let a=this;do a=a instanceof ShadowRoot?a.host:a.parentNode;while(a&&!j(a));this.$parent=a,F(this,"attached")}disconnectedCallback(){this.$parent=null,F(this,"detached")}attributeChangedCallback(a,b,c){F(this,"attribute",{name:a,old:b,value:c})}$commit(a,...b){if(a in this){if(!f(this[a]))throw new V(`Method '${a}' must be a function`);if(h(a))throw new V(`Could no call reserved method '${a}'`);this[a](this.state,...b)}}$render(){this.$rendering||(this.$emit("$render:before"),this.$rendering=!0,S(()=>{let a;try{this.$renderer.render()}catch(b){if(b instanceof V||(b=l(b)),Q.debug)throw b;a=b}this.$rendering=!1,a&&this.$emit("$render:error",a)}))}}return b.extendsBuiltIn=a!==HTMLElement,b.resolved=!1,b.prototype.$galaxy=b.$galaxy=!0,I(b,[na]),b}function N(a,...b){const c=document.createElement(a);return c.innerHTML=String.raw(...b),c}function O(a,b){const c=[];for(const d of a){if(d.resolved)continue;const a={},e=d.is;if(!e)throw new V("Unknown element tag name");if(d.extendsBuiltIn&&!(a.extends=d.extends))throw new V("Extended customized built-in elements must have an `extends` property");try{c.push(customElements.whenDefined(e)),P(d,b),Promise.all(O(d.children,b)).then(()=>{customElements.define(e,d,a)}),d.resolved=!0}catch(a){throw l(a)}}return c}function P(a,b){for(const c of b)c.install(a)}var Q={root:null,debug:!0,elements:[],directives:[],plugins:[],filters:{}},R="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?{}:self:global:window,S=b(function(a){(function(b,c){a.exports=c()})(R,function(){function a(d){a.waiting||b.then(a.flush),c.push(d)}const b=Promise.resolve(),c=a.queue=[];return Object.defineProperty(a,"waiting",{enumerable:!0,get(){return 0<c.length}}),a.afterFlush=b=>{setTimeout(()=>a.waiting?void a.afterFlush(b):b())},a.flush=()=>{if(a.waiting){const a=c.slice();c.length=0;for(const b of a)b()}},a})}),T=b(function(a){(function(b,c){a.exports=c()})(R,function(){const a=new WeakMap,b=Object.prototype.hasOwnProperty,c=a=>"[object Object]"===Object.prototype.toString.call(a)||Array.isArray(a),d=()=>{};class e{constructor(a){this.target=a,this.subscribers=new Set}static get observeOptions(){return{deep:!0,compare(a,b){return JSON.stringify(a)!==JSON.stringify(b)}}}static is(b){return c(b)&&a.has(b)}static get(b){return a.get(b)}static observe(f,g={},h=d){function i(a){h(a),l.dispatch(a)}if(e.is(f))return f;const{deep:j,compare:k}=Object.assign({},e.observeOptions,g),l=new e(f);if(j)for(const a in f)if(b.call(f,a)){const b=f[a];c(b)&&(f[a]=e.observe(b,g,i))}const m=new Proxy(f,{defineProperty(a,d,f){const{value:h}=f,l=a[d],m=b.call(a,d);j&&c(h)&&(f.value=e.observe(h,g,i));const n=Reflect.defineProperty(a,d,f);if(n&&(!m||k(h,l,d,a))){const b={type:m?"set":"add",value:h,property:d,target:a};m&&(b.old=l),i(b)}return n},deleteProperty(a,c){const d=a[c],e=b.call(a,c)&&Reflect.deleteProperty(a,c);return e&&i({type:"delete",old:d,property:c,target:a}),e}});return a.set(f,l),a.set(m,l),m}subscribe(a){return this.subscribers.add(a),this}unsubscribe(a){return this.subscribers.delete(a),this}dispatch(a){return this.subscribers.forEach(b=>{b(a,this.target)}),this}}return e})}),U={_$f(a,b){return b.reduce((a,b)=>{const c=Q.filters[b.name];return b.args?c(a,...b.args):c(a)},a)},_$n(a){return g(a)?a:""}};class V extends Error{}const W=/^(?<name>\w+)(?:\((?<args>.*)\))?$/,X=/{{(?<expression>.*?)}}/,Y=/\w/,Z=new Map;class ${constructor(a,b){this.node=a,this.renderer=b,this.getter=q(a.nodeValue)}static is({nodeValue:a}){return X.test(a)}render(){const a=this.getter(this.renderer.scope,this.renderer.isolated);this.node.nodeValue!==a&&(this.node.nodeValue=a)}}class _{constructor(a,b,c){this.scope=b,this.element=a,this.isolated=c,this.locals=Object.create(null),this.isPlaceholder=i(a),this.directives=[],this._init(a)}get isRenderable(){return this.directives.length}_init(a){const b=Array.from(a.attributes);for(const c of b){const{name:b,value:d}=c;$.is(c)&&this.directives.push(new $(c,this));for(const c of Q.directives){const e=c._match(b,a);if(e){const f={name:e.name,args:e.args?e.args.split("."):[],value:d};if(c.match(f,this)){const d=new c(f,this);d.init(),d.$options.$render&&this.directives.push(d),Q.debug||a.removeAttribute(b);break}}}}}render(){for(const a of this.directives)a.render()}}var aa=/[|\\{}()[\]^$+*?.]/g,ba=function(a){if("string"!=typeof a)throw new TypeError("Expected a string");return a.replace(aa,"\\$&")};class ca extends Event{constructor(a,b){super(a,b),this.$target=b.target,this.$stopped=!1,this.$performed=!1,this._transitionCb=b.transitionCb}stop(){this.$performed||(this.$stopped=!0)}play(){this.$performed||(this.$stopped=!1)}perform(){this.$stopped||this.$performed||(this.$stopped=!1,this.$performed=!0,this._transitionCb())}}const da=a=>a,ea=/-([a-z0-9])/gi,fa=/(?<=[a-z0-9])([A-Z])/g,ga="<name>";class ha extends _{constructor(a,b,c){super(a,b,C(c)),this.childrenRenderer=new ma((this.isPlaceholder?a.content:a).childNodes,b,this.isolated)}get isRenderable(){return super.isRenderable||0<this.childrenRenderer.renderers.length}get isFlattenable(){return 0<this.childrenRenderer.renderers.length&&!this.directives.length}render(){super.render(),(this.isPlaceholder||this.element.isConnected)&&this.childrenRenderer.render()}}class ia extends ha{constructor(a,b,c){super(a.cloneNode(!0),b.scope,C(b.isolated,c)),this.by=L(this.element),this.reused=!1}get children(){return this.childrenRenderer.children}get key(){return this.by()}get next(){return(this.isPlaceholder?this.children[this.children.length-1]:this.element).nextSibling}update(a){this.reused=!0,Object.assign(this.isolated,a)}insert(a,b="enter",c=!0){if(!this.isPlaceholder){const d=()=>a.before(this.element);return c?this._dispatchTransitionEvent(b,this.element,d):d()}const d=b=>a.before(b);this.children.forEach(a=>{c?this._dispatchTransitionEvent(b,this.element,()=>d(a)):d(a)})}remove(){return this.isPlaceholder?this.children.forEach(a=>{this._dispatchTransitionEvent("leave",this.element,()=>a.remove())}):void this._dispatchTransitionEvent("leave",this.element,()=>{this.element.remove()})}_dispatchTransitionEvent(a,b,c){K(this.element,`for:${a}`,b,c)}}const ja="*for",ka=/^\(?(?<value>\w+)(?:\s*,\s*(?<key>\w+)(?:\s*,\s*(?<index>\w+))?)?\)?\s+(?:in|of)\s+(?<expression>.+)$/;class la{constructor(a,b){this.template=a,this.renderer=b,this.items=[],this.values=new Map;const c=A(a,ja),{groups:d}=c.match(ka);this.keyName=d.key,this.indexName=d.index,this.valueName=d.value,this.startAnchor=B(`start for: ${c}`),this.endAnchor=B(`end for: ${c}`),this.getter=r(d.expression),a.replaceWith(this.startAnchor),this.startAnchor.nextSibling.before(this.endAnchor),a.hasAttribute("by")||(Q.debug&&console.warn("The element with the loop expression `"+c+"` doesn't have a `by` attribute, fallbacking to `$index` tracking."),a.setAttribute("by","$index"))}static is({attributes:a}){return ja in a}render(){const a=this.getter(this.renderer.scope,this.renderer.isolated),b=[],c=Object.keys(a);c.forEach((c,d)=>{let e=this.items[d];const f={$index:d,$key:c,[this.keyName]:c,[this.indexName]:d,[this.valueName]:a[c]};if(!e)e=new ia(this.template,this.renderer,f),e.insert(this.endAnchor),this.values.set(e.key,e);else{const a=e.by(f);if(e.key!==a){const b=this.values.get(a),c=b.next;b.insert(e.next,"move"),e.insert(c,null,!1),this.items[this.items.indexOf(b)]=e,this.items[d]=b,e=b}e.update(f)}b.push(e),e.render()});for(const a of this.items)a.reused?a.reused=!1:(this.values.delete(a.key.value),a.remove());this.items=b}}class ma{constructor(a,b,c){this.children=Array.from(a),this.scope=b,this.isolated=c,this.renderers=[],this._init()}_init(){for(const a of this.children)if(d(a)&&$.is(a))this.renderers.push(new $(a,this));else if(e(a))if(la.is(a))this.renderers.push(new la(a,this));else{const b=new((i(a)?a.content:a).childNodes.length?ha:_)(a,this.scope,this.isolated);b.isRenderable&&this.renderers.push(...(b.isFlattenable?E(b):[b]))}}render(){for(const a of this.renderers)a.render()}}var na={$on(a,b,c){(this.$events[a]=G(this.$events,a)).push(b),this.addEventListener(a,b,c)},$once(a,b,c={}){"boolean"==typeof c&&(c={capture:c});const d=a=>{H(b),b.call(this,a)};c.once=!0,d.listener=b,this.$on(a,d,c)},$off(a,b){switch(arguments.length){case 0:for(a in this.$events)this.$off(a);break;case 1:for(const b of G(this.$events,a))this.$off(a,b);break;default:H(this.$events,a,b),this.removeEventListener(a,b);}},$emit(a,b){this.dispatchEvent(a instanceof Event?a:new CustomEvent(a,{detail:b}))}};const oa=new WeakMap,pa={$plain:!1,$render:!0};class qa{static get is(){return z(this.name)}constructor(a,b){if(this.$name=a.name,this.$args=a.args,this.$value=a.value,this.$renderer=b,this.$scope=b.scope,this.$element=b.element,this.$options=Object.assign({},pa,this.constructor.options),!this.$options.$plain){const c=r(a.value);this.$getter=a=>c(b.scope,C(b.isolated,a))}}static get is(){return""}static match(){return!0}init(){}render(){}}qa._matcher=null,qa._match=function(a){const b=this._matcher.exec(a);return b&&b.groups};class ra extends qa{static get is(){return"*if"}get isPlaceholder(){return this.$renderer.isPlaceholder}init(){if(this.anchor=B(`if: ${this.$value}`),this.render=this.isPlaceholder?this._firstRenderMultiple:this._renderSingle,this.isPlaceholder&&(this.children=Array.from(this.$element.content.childNodes),!this.children.length))throw new V("placeholder element with a conditional must have at least one child node")}_renderSingle(){const{isConnected:a}=this.$element;let b;this.$getter()?!a&&(b="enter"):a&&(b="leave"),b&&this._dispatchTransitionEvent(b,this.$element,()=>{const a="leave"===b;this[a?"$element":"anchor"].replaceWith(this[a?"anchor":"$element"])})}_firstRenderMultiple(){this.$element.replaceWith(this.anchor),this.$getter()&&this._appendChildren(),this.render=this._renderMultiple}_renderMultiple(){if(this.$getter())this._appendChildren();else for(const a of this.children)a.isConnected&&this._dispatchTransitionEvent("leave",a,()=>a.remove())}_appendChildren(){let a=this.children.length;const{parentNode:b}=this.anchor;for(;a--;){const c=this.children[a];c.isConnected||this._dispatchTransitionEvent("enter",c,()=>{b.insertBefore(c,this.anchor.nextSibling)})}}_dispatchTransitionEvent(a,b,c){K(this.$element,`if:${a}`,b,c)}}class sa extends qa{static get is(){return"@<name>"}static get options(){return{$plain:!0,$render:!1}}init(){const{$args:a,$scope:b,$name:c,$element:d,$renderer:e}=this,f=a.includes("once"),g=s(this.$value);let h;const i=[];let k="addEventListener";a.includes("self")&&i.push((a,b)=>{b.target===b.currentTarget&&a(b)}),a.includes("prevent")&&i.push((a,b)=>{b.preventDefault(),a(b)}),j(d)?k=`$on${f?"ce":""}`:f&&i.push((a,b)=>{d.removeEventListener(c,h),a(b)}),i.push((a,c)=>{g(b,C(e.isolated,{$event:c})),a()}),d[k](c,h=J(i))}}class ta extends qa{static get is(){return".<name>"}init(){this._inCustom=j(this.$element),this.$element[this.$name]=null}render(){this.$element[this.$name]=this.$getter(),this._inCustom&&this.$element.$render()}}class ua extends qa{static get is(){return"ref"}init(){this.refName=y(this.$value)}render(){const{$scope:a,$element:b,refName:c}=this;b.isConnected?a.$refs[c]=b:delete a.$refs[c]}}class va extends qa{static get is(){return":<name>"}_getObserved(){let a=this.$element.getAttributeNode(this.$name);return Q.debug||this.$element.removeAttribute(this.$name),a||(a=document.createAttribute(this.$name),this.$element.setAttributeNode(a)),a}init(){this.attribute=this._getObserved()}render(){const a=this.$getter();"boolean"==typeof a?this.element[`${a?"set":"remove"}AttributeNode`](this.attribute):D(this.attribute,a)&&(this.attribute.value=a)}}class wa extends va{static get is(){return":class"}_getNormalized(){const a=this.$getter();if(!Array.isArray(a))return a;return a.forEach(a=>{c(a)?Object.assign(result,a):result[a]=1}),{}}render(){const a=this._getNormalized();if(!c(a))return super.render();for(const b in a)a.hasOwnProperty(b)&&this.$element.classList[a[b]?"add":"remove"](b)}}class xa extends va{static get is(){return":style"}static parseRule(a){const b=a.split(".");return{prop:b[0],unit:b[1]}}init(){this.styles={}}render(){const a=this.$getter();if(!c(a))return super.render();const b=this.$element.attributeStyleMap;for(const c in this.styles)a.hasOwnProperty(c)||b.delete(xa.parseRule(c).prop);for(const c in a){const d=a[c];if(this.styles[c]!==d){const{prop:a,unit:e}=xa.parseRule(c);b[d?"set":"delete"](a,e?CSS[e](d):d)}}this.styles=Object.assign({},a)}}class ya extends qa{static get is(){return"*bind"}init(){this.setting=!1;const a=u(this.$value);this.setter=b=>{a(this.$scope,this.$renderer.isolated,b)},this.onInput&&this.$element.addEventListener("input",this.onInput.bind(this)),this.onChange&&this.$element.addEventListener("change",this.onChange.bind(this))}static setMultiple(a,b,c){const d=c.indexOf(b);a?-1===d&&c.push(b):-1<d&&c.splice(d,1)}setValue(a){this.setting=!0,this.setter(a)}render(){this.setting?this.setting=!1:this.update(this.$element,this.$getter())}}class za extends ya{static match(a,{element:b}){return"checkbox"===b.type}onChange({target:a}){const b=this.$getter();return Array.isArray(b)?void ya.setMultiple(a.checked,a.value,b):this.setValue(a.checked)}update(a,b){a.checked=!!b}}class Aa extends ya{static match(a,{element:b}){return"radio"===b.type}onChange({target:a}){a.checked&&this.setValue(a.value)}update(a,b){a.checked=b+""===a.value}}class Ba extends ya{static match(a,{element:b}){return b instanceof HTMLInputElement||b instanceof HTMLTextAreaElement}init(){switch(super.init(),this.valueKey="value",this.$args[0]){case"number":this.valueKey+="AsNumber";break;case"date":this.valueKey+="AsDate";}}onInput({target:a}){this.setValue(a[this.valueKey])}update(a,b){a[this.valueKey]!==b&&(a[this.valueKey]=b)}}class Ca extends ya{static match(a,{element:b}){return b instanceof HTMLSelectElement}onChange({target:a}){const{options:b,multiple:c}=a;if(!c){for(const{value:a,selected:c}of b)if(c)return this.setValue(a);}else{const a=this.$getter();if(!Array.isArray(a))throw new V("Invalid bound value. *bind directive on select elements with a `multiple` attribute must have an array bound value.");for(const c of b)ya.setMultiple(c.selected,c.value,a)}}update(a,b){for(const c of a.options)c.selected=a.multiple?-1<b.indexOf(c.value):b===c.value}}class Da{static init(){}static install(){}static with(a){return Object.assign(this.$options,this.$defaults,a),this}}_defineProperty(Da,"$options",{}),_defineProperty(Da,"$defaults",{});const Ea=M(HTMLElement);a.config=Q,a.extend=M,a.GalaxyElement=Ea,a.html=function(...a){return N("template",...a)},a.css=function(...a){const b=N("style",...a);return b.setAttribute("skip",""),b},a.setup=function(a){if(Object.assign(Q,a),Q.plugins)for(const a of Q.plugins)a.init(Q);Q.directives.unshift(...[ra,sa,ta,ua,wa,xa,va,za,Aa,Ba,Ca]);for(const b of Q.directives)b._matcher=w(b.is);if(!Q.root)throw new V("You must include a `root` option");O([Q.root,...Q.elements],Q.plugins)},a.GalaxyDirective=qa,a.GalaxyPlugin=Da,a.withCachedInstance=function(a){const b=a.init;return a.init=function(c){this.$instance=new a(this.$options),b.call(this,c)},a},Object.defineProperty(a,"__esModule",{value:!0})});