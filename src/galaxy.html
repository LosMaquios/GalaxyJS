<script type="module">
  import Renderer from './Renderer.js'
  import Observer from './Observer.js'

  import { isObject } from './utils/type-check.js'

  class Galaxy {}

  class Element extends HTMLElement {
    constructor () {
      super()

      this.$document = document.currentScript.ownerDocument
      this.$template = this.$document.querySelector('template')

      this.$shadow = this.attachShadow({ mode: 'open' })

      const content = this.$template.content

      this.$observer = new Observer()

      // Default initial state
      // Just an empty pointer
      this.initialState = {}
      this.state = new Proxy(this.initialState, {})

      this.$root = content.cloneNode(true)
      this.$renderer = new Renderer(this.$root.childNodes)

      this.$shadow.appendChild(this.$root)
    }

    _onStateChange (target, property, value, receiver) {
      value = isObject(value) ? this.$observer.observe(value) : value

      Reflect.set(target, property, value, receiver)

      // Pass to rendering phase
      this.render()
    }

    setState (state) {
      this.initialState = Object.assign({}, state)

      // State is a proxy
      this.state = this.$observer.observe(state)

      this.$observer.sub(this._onStateChange.bind(this))

      this.render()
    }

    render (force) {
      this.$renderer.render(this.state, force)
    }
  }

  Galaxy.Element = Element

  window.Galaxy = Galaxy
</script>
