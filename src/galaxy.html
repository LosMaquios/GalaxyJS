<script type="module">
  import nextTick from './next-tick.js'
  import Observer from './Observer.js'

  class Galaxy {}

  class Element extends HTMLElement {
    static get TEMPLATE_REGEX () {
      return /{{(.*?)}}/g
    }

    constructor () {
      super()

      this.$document = document.currentScript.ownerDocument
      this.$template = this.$document.querySelector('template')

      this.$shadow = this.attachShadow({ mode: 'open' })

      const content = this.$template.content

      this.$observer = new Observer()

      // Default initial state
      // Just an empty pointer
      this.initialState = {}
      this.state = new Proxy(this.initialState, {})

      this.$content = content.cloneNode(true)

      this.__renderFns = []

      this._setupRender(this.$content.childNodes)

      this.$shadow.appendChild(this.$content)
    }

    setState (state) {
      this.initialState = Object.assign({}, state)

      // State is a proxy
      this.state = this.$observer.observe(state)

      this.$observer.sub(this._onStateChange.bind(this))

      this.render()
    }

    _onStateChange (target, property, value, receiver) {
      value = isObject(value) ? this.$observer.observe(value) : value

      Reflect.set(target, property, value, receiver)

      // Pass to rendering phase
      this.render()
    }

    _setupRender (nodes) {
      for (const node of nodes) {
        if (node instanceof Text && node.data.indexOf('{{') > -1) {
          const template = node.data

          this.__renderFns.push(() => {
            node.data = template.replace(Element.TEMPLATE_REGEX, (_, expression) => {
              return (new Function(`with (this) { return ${expression} }`)).call(this.state)
            })
          })
        }

        if (node.firstChild) {
          this._setupRender(node.childNodes)
        }
      }
    }

    render () {
      nextTick(() => {
        for (const renderFn of this.__renderFns) {
          renderFn()
        }
      })
    }
  }

  Galaxy.Element = Element

  window.Galaxy = Galaxy
</script>
